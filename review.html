<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Review - MI 22</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;700&display=swap" rel="stylesheet">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>
    <script type="text/javascript">
       (function(){
          emailjs.init({
            publicKey: "GNmXoBgDWC3HeWVga",
          });
       })();
    </script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHJUml-DnP12ehdZjwm8EXg-vJ8We_Rcw",
            authDomain: "gloryangkatan22.firebaseapp.com",
            projectId: "gloryangkatan22",
            storageBucket: "gloryangkatan22.firebasestorage.app",
            messagingSenderId: "209237801158",
            appId: "1:209237801158:web:a1fefcbc50e2e4aeca3fc7",
            measurementId: "G-T6TKLBPDZF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firestore = { collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, getDocs };
    </script>
    
    <style>
        body {
            font-family: 'Barlow', sans-serif;
        }
        
        .file-card {
            transition: all 0.3s ease;
        }
        .animate-bounce {
        animation: bounce 1s infinite;
        }
        @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
        }

        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .commented {
            border-left: 4px solid #10b981;
        }
        
        .uncommented {
            border-left: 4px solid #f59e0b;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .comment-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
        .nav-link.active {
            background-color: rgba(59, 130, 246, 0.3);
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
        }
        
        .modal-overlay {
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-content {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header yang sama dengan index.html -->
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="flex justify-between items-center px-10 py-6">
            <div>
                <h1 class="text-3xl font-bold">MI 22, Bismillah LULUS</h1>
                <p class="mt-2 text-blue-200">Document Review System</p>
            </div>
            <div class="text-right">
                <h3 class="text-blue-200 text-sm font-medium">Last Updated</h3>
                <p class="text-xl font-medium text-white mt-1" id="last-updated">-</p>
            </div>
        </div>
        
        <!-- Navigation Menu -->
        <nav class="bg-blue-900 px-10 py-3 border-t border-blue-700">
            <div class="flex space-x-8">
                <a href="#" class="nav-link text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2" onclick="showLoginModal()">
                    <span>üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="/review.html" class="nav-link active text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2">
                    <span>üìÑ</span>
                    <span>Document Review</span>
                </a>
                <a href="/about.html" class="nav-link text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2">
                    <span>‚ÑπÔ∏è</span>
                    <span>About Us</span>
                </a>
            </div>
        </nav>
    </header>
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden flex items-center justify-center z-50">
        <div class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-md mx-4">
            <!-- Modal Header -->
            <div class="bg-blue-800 text-white px-6 py-4 rounded-t-lg">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold flex items-center space-x-2">
                        <span>üîê</span>
                        <span>Dashboard Access</span>
                    </h2>
                    <button onclick="closeLoginModal()" class="text-blue-200 hover:text-white transition-colors duration-200 text-2xl">
                        √ó
                    </button>
                </div>
                <p class="text-blue-200 text-sm mt-1">Please enter your credentials to continue</p>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6">
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="space-y-4">
                        <!-- Username Field -->
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
                                Username
                            </label>
                            <input 
                                type="text" 
                                id="username" 
                                name="username"
                                class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                placeholder="Enter your username"
                                required
                            >
                        </div>
                        
                        <!-- Password Field -->
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                                Password
                            </label>
                            <input 
                                type="password" 
                                id="password" 
                                name="password"
                                class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                                placeholder="Enter your password"
                                required
                            >
                        </div>
                        
                
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-3">
                          <p class="text-sm text-blue-800 font-medium">
                            Don‚Äôt have access? Please enter your email below to request access:
                          </p>
                          <div class="flex flex-col sm:flex-row sm:items-center sm:space-x-3 space-y-2 sm:space-y-0">
                            <input 
                              type="email" 
                              id="email" 
                              name="email"
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors duration-200"
                              placeholder="Enter your email"
                            >
                            <button 
                              type="button" 
                              onclick="handleSendRequest()" 
                              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium"
                            >
                              Send
                            </button>
                          </div>
                        </div>
                        
                        <!-- Error Message -->
                        <div id="errorMessage" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                            <p class="text-sm text-red-800">‚ùå Invalid username or password. Please try again.</p>
                        </div>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="flex space-x-3 mt-6">
                        <button 
                            type="button" 
                            onclick="closeLoginModal()"
                            class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors duration-200 font-medium"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            class="flex-1 px-4 py-3 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors duration-200 font-medium"
                        >
                            Login
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="w-full px-4 sm:px-6 lg:px-8 py-8">

        <!-- Upload Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">üì§ Unggah Dokumen Baru</h2>
            <div id="uploadArea" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                <div class="space-y-4">
                    <div class="text-4xl">üìÅ</div>
                    <div>
                        <p class="text-lg font-medium text-gray-700">Klik atau seret file ke sini</p>
                        <p class="text-sm text-gray-500">Mendukung PDF SAJA (.pdf)</p>
                    </div>
                    <input type="file" id="fileInput" onchange="handleFileUpload(this.files[0])" accept=".pdf,.doc,.docx" class="hidden">
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
          <div class="flex flex-wrap gap-4">
            <h3 class="text-lg font-semibold text-gray-800 w-full">Filter:</h3>
            
            <button onclick="filterFiles('all')" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
              Semua File
            </button>
        
            <button onclick="filterFiles('commented')" class="filter-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
              üí¨ Ada Komentar
            </button>
        
            <button onclick="filterFiles('uncommented')" class="filter-btn bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
              ‚è≥ Belum Ada Komentar
            </button>
        
            <select id="dateFilter" onchange="filterByDate()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="all">Semua Tanggal</option>
            </select>
          </div>
        </div>


        <!-- Documents Section -->
        <div class="space-y-6" id="documentsContainer">
            <!-- Documents will be dynamically added here -->
        </div>
    </div>

    <!-- Comment Modal with File Preview -->
    <div id="commentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-7xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üìÑ</span>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Review Dokumen</h3>
                            <p class="text-sm text-gray-600" id="modalSubtitle">Preview dan komentar</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
                </div>
            </div>
            
            <div id="uploadLoading" class="text-center text-blue-600 font-medium hidden">
                ‚è≥ Sedang mengunggah dokumen...
              </div>
              
            <!-- Split Content -->
            <div class="flex h-[calc(90vh-120px)]">
                <!-- Left Panel - File Preview -->
                <div class="w-1/2 border-r border-gray-200 bg-gray-50">
                    <div class="p-4 border-b border-gray-200 bg-white">
                        <h4 class="font-medium text-gray-800 flex items-center">
                            <span class="mr-2">üëÅÔ∏è</span>
                            Preview Dokumen
                        </h4>
                    </div>
                    <div class="p-6 h-full overflow-auto">
                        <div id="filePreviewContainer" class="h-full flex items-center justify-center">
                            <!-- File preview will be loaded here -->
                            <div class="text-center text-gray-500">
                                <div class="text-6xl mb-4">üìÑ</div>
                                <p class="text-lg">Loading preview...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel - Comments -->
                <div class="w-1/2 flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-white">
                        <h4 class="font-medium text-gray-800 flex items-center justify-between">
                            <span class="flex items-center">
                                <span class="mr-2">üí¨</span>
                                Komentar & Diskusi
                            </span>
                            <span id="commentCount" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">0</span>
                        </h4>
                    </div>
                    
                    <!-- Comments List -->
                    <div class="flex-1 p-4 overflow-y-auto bg-gray-50">
                        <div id="commentsContainer" class="space-y-4">
                            <!-- Comments will be displayed here -->
                        </div>
                    </div>
                    
                    <!-- Comment Input -->
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <div class="space-y-3">
                            <textarea id="newComment" placeholder="Tulis komentar atau feedback Anda..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="3"></textarea>
                            <div class="flex items-center justify-between">
                                <input type="text" id="commenterName" placeholder="Nama Anda" class="flex-1 mr-3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button onclick="addComment()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                    <span>üì§</span>
                                    <span>Kirim</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let documents = [];
        let currentDocumentId = null;
        let unsubscribeDocuments = null;
        let isUploading = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            setupUploadArea();
            initializeFirestore();
        });

        const DROPBOX_TOKEN = 'sl.u.AF4rRDjnuw-N5qqh7ewwD50MD7U8TEYHE3xTVJwp5OioR3X7FNpWPApv-82bCy2pHoZzH-uMgNwuXQVItWdT7jpTJD4vMCKG0a6vAqFy4FIp-5lOcRPlSu5ediA7GhNJ8uRb5QpanlB2DC_suewJgntRlhlQ2CBeHZLmNv_UY38a9K6jQrSGheFn-xlY7SngYc52f85373CwXtCFkjkKfW2_QT2-AY8ffdBgNiUJNE3dN4cCHZCQ4GfhQoasYzZ3EIrkADndWTnla4ZD-t5LfaMnvPkoR6V9SbbiZhCdnTsYHc0nYO4wZaBIuxveuxBll7PNrcE__ys8uEUoXgdhowL6CZdlKaQK9bgQdvP1eu2rvzdhXhzp4aOYFxmdAHkFuOMSTJiwzoMb8qZoEPiCjDI72xactWrD0F_91_liK8TrepJgilx78TE5S_p2V-7yygEGeuHIEg9ShEm3dMC-gW8dUrGzcXEbttAp3EJvKIma1fVAvkk-f5sJ-gufBpu5DkXXrrBBUKm1hqwNOs9AnsCWm52YoG4fEX3fCKcRT7DyRMEY4jpBANLQYo7pzINOq2F04Hs9YmKkEcxsPYovKlO38iTm3ofNenEHrIgCMqn6rcJOlCEBrK3rxGXqg19K6Gyrcjir8jXlerFwNsXKfJ4mJFHiWTX6jIfOrIZHi9o-6Ge7vCDRXw8ugrA4alz13FFJebexD0hAE3GHQZU67RIWYiBiRVGTJcdCvG01gl63T1RrWLwFwny5rH-B-6JYXTKQn2fpaGaxrQnTdIXdALrinVbHtSCneEz-5CX_tdubJUOsRNBOQxkUQmMkVXdnv-X9tgY_b807ClRJOcl_2BnPZFSq87kd69xJnTjEDXy3svlF5yuMlH5H9IU9f_xrm8nQJkowkIubYFtjr6QOzgr6v6LuxiCnmL9IkFQWa64mUjiLkxgm_ia3LAjRlY8tK7Z9dPRvt3zDMIWDRa0dque567W6fyJ75O6MVr86pSULkGdHwQ8IWwViP51SzR1NH79LzWcUPgGtp8TbLjS6KGicoAXyWGdp3asbp3ARweIuRiSnxorDCfRWWqHv5y6L5Zghsr2wMo6GVrMxOiGKcf5HVAMbYHl4KZmMhBtcFPS9Glv7Zm42OwqaU61SoM-G3OiPx0ZDCf_wIfRgc0BA6rQcWPRHTxzg3aqYvVDqg4S90jGJJwBLDihAGmvJtlfgTEglXNU0gW6QcDZAYVUUra6DzwlGTToSuO-F9p64KXHtcAy5p_2GQdzw-NY7HYixagkWQZvPq4yB02lNnyfyX8KvnnzHnkgO5dvl9leXKIWrt8JpUS8Q8bSAzQI-g3GfosWBlfeP1cPEFjgndrgxvDgF2OjR3LxXpNlcnKHjyfE2Sw';
        async function uploadToDropbox(file) {
            const DROPBOX_UPLOAD_URL = 'https://content.dropboxapi.com/2/files/upload';
            
            const response = await fetch(DROPBOX_UPLOAD_URL, {
                method: 'POST',
                headers: {
                'Authorization': `Bearer ${DROPBOX_TOKEN}`,
                'Content-Type': 'application/octet-stream',
                'Dropbox-API-Arg': JSON.stringify({
                    path: `/uploads/${Date.now()}_${file.name}`,
                    mode: 'add',
                    autorename: true,
                    mute: false
                })
                },
                body: file
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Dropbox API Error Response:", errorText);
                console.error("HTTP Status:", response.status);
                throw new Error(`Error from Dropbox API (${response.status}): ${errorText}`);
            }
            return await response.json();
        }
        
        async function getShareableLink(filePath) {
            const DROPBOX_SHARE_URL = 'https://api.dropboxapi.com/2/sharing/create_shared_link_with_settings';
            
            const response = await fetch(DROPBOX_SHARE_URL, {
                method: 'POST',
                headers: {
                'Authorization': `Bearer ${DROPBOX_TOKEN}`,
                'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                path: filePath,
                settings: {
                    requested_visibility: 'public' // Set link jadi publik
                }
                })
            });
            return await response.json();
        }
        // Show login modal
        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('username').focus();
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Close login modal
        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginForm').reset();
            document.getElementById('errorMessage').classList.add('hidden');
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            

            try {
                const usersCollection = window.firestore.collection(window.db, 'userpass');

                const q = window.firestore.query(usersCollection);

                const querySnapshot = await window.firestore.getDocs(q);

                let found = false;

                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    if (data.username === username && data.password === password) {
                        found = true;
                    }
                });

                if (found) {
                    localStorage.setItem('isLoggedIn', 'true');
                    closeLoginModal();
                    showNotification('‚úÖ Login successful! Redirecting to dashboard...', 'success');
                    window.location.href = '/index.html';
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    document.getElementById('password').value = '';
                    document.getElementById('password').focus();
                }
            } catch (error) {
                console.error("Error during login: ", error);
                showNotification('‚ùå Login failed. Please try again later.', 'error');
            }
        }

        // Show info function (placeholder)
        function showInfo() {
            showNotification('About Us: MI 22 Document Review System - Bismillah LULUS! üéì','success'); 
        }
        function handleSendRequest() {
            const emailInput = document.getElementById("email");
            const email = emailInput.value.trim();
        
            if (email === "") {
              showNotification('Please enter your email.','error'); 
              return;
            }
        
            const templateParams = {
              requester_email: email,
            };
        
            emailjs.send('service_z7y0yvq', 'template_ao7othl', templateParams)
              .then(function(response) {
                showNotification('‚úÖ Email request sent successfully!','success'); 
                emailInput.value = "";
              }, function(error) {
                showNotification('‚ùå Failed to send email. Please try again later.','error'); 
                console.error(error);
              });
          }

        // Close modal when clicking outside
        document.getElementById('loginModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeLoginModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeLoginModal();
            }
        });

        // Initialize Firestore listeners
        function initializeFirestore() {
            if (!window.db) {
                setTimeout(initializeFirestore, 100);
                return;
            }
            
            // Listen to documents collection
            const documentsQuery = window.firestore.query(
                window.firestore.collection(window.db, 'documents'),
                window.firestore.orderBy('uploadDate', 'desc')
            );
            
            unsubscribeDocuments = window.firestore.onSnapshot(documentsQuery, (snapshot) => {
                documents = [];
                snapshot.forEach((doc) => {
                    documents.push({ id: doc.id, ...doc.data() });
                });
                renderDocuments();
                updateDateFilter();
            });
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('last-updated').textContent = today.toLocaleDateString('id-ID', options);
        }

        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileUpload(e.dataTransfer.files[0]);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0]);
            });
        }

        async function handleFileUpload(file) {
            if (isUploading) return;
            isUploading = true;
            document.getElementById('uploadLoading').classList.remove('hidden');

            try {
                const uploadResult = await uploadToDropbox(file);
                const shareResult = await getShareableLink(uploadResult.path_lower);
                const fileUrl = shareResult.url.replace('dl=0', 'raw=1');

                const now = new Date();
                const uploadDate = now.toISOString().split('T')[0];
                const uploadTime = now.toLocaleTimeString('id-ID', { hour12: false }).replaceAll(':', '.');

                await window.firestore.addDoc(
                window.firestore.collection(window.db, 'documents'),
                {
                    name: file.name.replace(/^.*?_/, ''),
                    url: fileUrl,
                    type: file.type || 'application/octet-stream',
                    size: file.size,
                    commentCount: 0,
                    timestamp: window.firestore.serverTimestamp(),
                    uploadDate,
                    uploadTime
                }
                );

                showNotification('‚úÖ File berhasil diupload!', 'success');
            } catch (error) {
                showNotification('‚ùå Gagal mengupload file!', 'error');
            } finally {
                isUploading = false;
                document.getElementById('uploadLoading').classList.add('hidden');
            }
            }

        async function loadDocuments() {
            try {
                const { query, collection, orderBy, getDocs } = window.firestore; // ‚¨ÖÔ∏è Tambahkan ini
                const q = query(
                collection(db, 'documents'),
                ('uploadedAt', 'desc')
                );

                const querySnapshot = await getDocs(q);
                const documentsList = [];

                querySnapshot.forEach((doc) => {
                documentsList.push({
                    id: doc.id,
                    ...doc.data()
                });
                });

                const container = document.getElementById('documentsContainer'); // perbaiki typo di id
                container.innerHTML = '';

                documentsList.forEach(doc => {
                const docElement = `
                    <div class="document-item">
                    <h3>${doc.name}</h3>
                    <a href="${doc.url}" target="_blank" download>üì• Download</a>
                    </div>
                `;
                container.innerHTML += docElement;
                });

            } catch (error) {
                console.error("Error loading documents:", error);
                showNotification('Gagal memuat dokumen. Cek konsol untuk detail.', 'success');
            }
        }



        function renderDocuments() {
            const container = document.getElementById('documentsContainer');
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìÑ</div>
                        <h3 class="text-xl font-medium text-gray-600 mb-2">Belum ada dokumen</h3>
                        <p class="text-gray-500">Unggah dokumen pertama Anda untuk memulai kolaborasi</p>
                    </div>
                `;
                return;
            }

            // Group documents by date
            const groupedDocs = documents.reduce((groups, doc) => {
                const date = doc.uploadDate;
                if (!groups[date]) groups[date] = [];
                groups[date].push(doc);
                return groups;
            }, {});

            let html = '';
            
            Object.keys(groupedDocs).sort().reverse().forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                html += `
                    <div class="date-group" data-date="${date}">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mr-3">üìÖ</span>
                            ${formattedDate}
                        </h3>
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                `;
                
                groupedDocs[date].forEach(doc => {
                    const hasComments = doc.commentCount > 0;
                    const fileIcon = getFileIcon(doc.type);
                    const fileSize = formatFileSize(doc.size);
                    
                    html += `
                        <div class="file-card bg-white rounded-lg shadow-md p-6 ${hasComments ? 'commented' : 'uncommented'}" data-status="${hasComments ? 'commented' : 'uncommented'}">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="text-3xl">${fileIcon}</div>
                                    <div>
                                        <h4 class="font-medium text-gray-800 truncate" title="${doc.name}">${doc.name}</h4>
                                        <p class="text-sm text-gray-500">${fileSize} ‚Ä¢ ${doc.uploadTime}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${hasComments ? 
                                        `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                            üí¨ ${doc.commentCount}
                                        </span>` : 
                                        `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                                            ‚è≥ Belum ada komentar
                                        </span>`
                                    }
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <button onclick="openCommentModal('${doc.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    ${hasComments ? 'Lihat Komentar' : 'Tambah Komentar'}
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getFileIcon(type) {
            if (type === 'application/pdf') return 'üìÑ';
            if (type.includes('word')) return 'üìù';
            return 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openCommentModal(docId) {
            currentDocumentId = docId;
            const doc = documents.find(d => d.id === docId);
            
            document.getElementById('modalTitle').textContent = `Review: ${doc.name}`;
            document.getElementById('modalSubtitle').textContent = `${formatFileSize(doc.size)} ‚Ä¢ Uploaded ${doc.uploadTime}`;
            document.getElementById('commentModal').classList.remove('hidden');
            document.getElementById('commentModal').classList.add('flex');
            
            // Load file preview
            loadFilePreview(doc);
            
            setupCommentsListener();
        }

        function loadFilePreview(doc) {
                const container = document.getElementById('filePreviewContainer');

                // Tampilkan loading spinner dulu
                container.innerHTML = `
                    <div class="text-center text-gray-500 p-8">
                    <div class="text-4xl animate-bounce mb-4">üîÑ</div>
                    <p class="text-lg font-medium">Sedang memuat preview...</p>
                    </div>
                `;

                setTimeout(() => {
                    if (doc.type === 'application/pdf') {
                    container.innerHTML = `
                        <div class="w-full h-full">
                        <iframe src="${doc.url}" class="w-full h-full border-0 rounded-lg" type="application/pdf">
                            <div class="text-center text-gray-500 p-8">
                            <div class="text-6xl mb-4">üìÑ</div>
                            <p class="text-lg font-medium">PDF Preview</p>
                            <p class="text-sm mb-4">Browser tidak mendukung preview PDF</p>
                            <a href="${doc.url}" download="${doc.name}" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                                üì• Download PDF
                            </a>
                            </div>
                        </iframe>
                        </div>
                    `;
                    } else if (doc.type.includes('word')) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 p-8">
                        <div class="text-6xl mb-4">üìù</div>
                        <p class="text-lg font-medium">${doc.name}</p>
                        <p class="text-sm mb-6">Preview Word tidak tersedia di browser</p>
                        <a href="${doc.url}" download="${doc.name}" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            üì• Download
                        </a>
                        </div>
                    `;
                    } else {
                    container.innerHTML = `
                        <div class="text-center text-gray-500 p-8">
                        <div class="text-6xl mb-4">üìÑ</div>
                        <p class="text-lg font-medium">${doc.name}</p>
                        <p class="text-sm mb-6">Preview tidak tersedia</p>
                        <a href="${doc.url}" download="${doc.name}" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                            üì• Download
                        </a>
                        </div>
                    `;
                    }
                }, 500); // Tambahkan sedikit delay agar loading spinner terlihat
                }

        let unsubscribeComments = null;

        function setupCommentsListener() {
            // Unsubscribe from previous listener
            if (unsubscribeComments) {
                unsubscribeComments();
            }

            // Listen to comments for current document
            const commentsQuery = window.firestore.query(
                window.firestore.collection(window.db, 'comments'),
                window.firestore.orderBy('timestamp', 'desc')
            );

            unsubscribeComments = window.firestore.onSnapshot(commentsQuery, (snapshot) => {
                const comments = [];
                snapshot.forEach((doc) => {
                    const comment = { id: doc.id, ...doc.data() };
                    if (comment.documentId === currentDocumentId) {
                        comments.push(comment);
                    }
                });
                renderComments(comments);
            });
        }

        function closeModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.getElementById('commentModal').classList.remove('flex');
            document.getElementById('newComment').value = '';
            document.getElementById('commenterName').value = '';
            
            // Clear file preview
            document.getElementById('filePreviewContainer').innerHTML = `
                <div class="text-center text-gray-500">
                    <div class="text-6xl mb-4">üìÑ</div>
                    <p class="text-lg">Loading preview...</p>
                </div>
            `;
            
            // Unsubscribe from comments listener
            if (unsubscribeComments) {
                unsubscribeComments();
                unsubscribeComments = null;
            }
            
            currentDocumentId = null;
        }

        function renderComments(comments) {
            const container = document.getElementById('commentsContainer');
            const countElement = document.getElementById('commentCount');
            
            // Update comment count
            countElement.textContent = comments.length;
            
            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üí¨</div>
                        <p class="font-medium">Belum ada komentar</p>
                        <p class="text-sm">Jadilah yang pertama memberikan feedback!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            comments.forEach((comment, index) => {
                const timestamp = comment.timestamp ? 
                    new Date(comment.timestamp.seconds * 1000).toLocaleString('id-ID') : 
                    comment.timestampString || 'Baru saja';
                    
                html += `
                    <div class="comment-bubble bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    ${comment.author.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <span class="font-medium text-gray-800">${comment.author}</span>
                                    <div class="text-xs text-gray-500">${timestamp}</div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">#${index + 1}</span>
                        </div>
                        <p class="text-gray-700 leading-relaxed">${comment.text}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Auto scroll to bottom when new comment is added
            container.scrollTop = container.scrollHeight;
        }

        async function addComment() {
            const commentText = document.getElementById('newComment').value.trim();
            const commenterName = document.getElementById('commenterName').value.trim();
            
            if (!commentText || !commenterName) {
                
                showNotification('‚ùå Isi nama n komentar broww', 'error');
                return;
            }
            
            try {
                const commentData = {
                    documentId: currentDocumentId,
                    author: commenterName,
                    text: commentText,
                    timestamp: window.firestore.serverTimestamp(),
                    timestampString: new Date().toLocaleString('id-ID')
                };
                
                // Add comment to Firestore
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'comments'),
                    commentData
                );

                // Update document comment count
                const docRef = window.firestore.doc(window.db, 'documents', currentDocumentId);
                const doc = documents.find(d => d.id === currentDocumentId);
                await window.firestore.updateDoc(docRef, {
                    commentCount: (doc.commentCount || 0) + 1
                });
                
                document.getElementById('newComment').value = '';
                document.getElementById('commenterName').value = '';
                
                showNotification('‚úÖ Komentar berhasil ditambahkan!', 'success');
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('‚ùå Gagal menambahkan komentar!', 'error');
            }
        }

        async function deleteDocument(docId) {
            if (confirm('Apakah Anda yakin ingin menghapus dokumen ini?')) {
                try {
                    // Delete document from Firestore
                    await window.firestore.deleteDoc(
                        window.firestore.doc(window.db, 'documents', docId)
                    );

                    // Delete associated comments
                    const commentsQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'comments')
                    );
                    
                    const commentsSnapshot = await window.firestore.onSnapshot(commentsQuery, async (snapshot) => {
                        const batch = [];
                        snapshot.forEach((doc) => {
                            const comment = doc.data();
                            if (comment.documentId === docId) {
                                batch.push(window.firestore.deleteDoc(doc.ref));
                            }
                        });
                        await Promise.all(batch);
                    });

                    showNotification('‚úÖ Dokumen berhasil dihapus!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting document:', error);
                    showNotification('‚ùå Gagal menghapus dokumen!', 'error');
                }
            }
        }

        function filterFiles(status) {
            const cards = document.querySelectorAll('.file-card');
            
            cards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-300');
            });
            event.target.classList.add('ring-2', 'ring-blue-300');
        }

        function updateDateFilter() {
            const dateFilter = document.getElementById('dateFilter');
            const dates = [...new Set(documents.map(doc => doc.uploadDate))].sort().reverse();
            
            // Clear existing options except "Semua Tanggal"
            dateFilter.innerHTML = '<option value="all">Semua Tanggal</option>';
            
            dates.forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID');
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formattedDate;
                dateFilter.appendChild(option);
            });
        }

        function filterByDate() {
            const selectedDate = document.getElementById('dateFilter').value;
            const dateGroups = document.querySelectorAll('.date-group');
            
            dateGroups.forEach(group => {
                if (selectedDate === 'all' || group.dataset.date === selectedDate) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        // Close modal when clicking outside
        document.getElementById('commentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-blue-500');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Handle Enter key in comment textarea
        document.getElementById('newComment').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                addComment();
            }
        });

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966069e722687549',t:'MTc1MzY2NDE1NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
