<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Review - MI 22</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Firebase SDK (Firestore only) -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHJUml-DnP12ehdZjwm8EXg-vJ8We_Rcw",
            authDomain: "gloryangkatan22.firebaseapp.com",
            projectId: "gloryangkatan22",
            storageBucket: "gloryangkatan22.firebasestorage.app",
            messagingSenderId: "209237801158",
            appId: "1:209237801158:web:a1fefcbc50e2e4aeca3fc7",
            measurementId: "G-T6TKLBPDZF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase available globally
        window.db = db;
        window.firestore = { collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp };
    </script>
    
    <!-- IndexedDB for File Storage -->
    <script>
        // IndexedDB setup for file storage
        class FileStorage {
            constructor() {
                this.dbName = 'MI22DocumentStorage';
                this.version = 1;
                this.db = null;
            }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.version);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files', { keyPath: 'id' });
                        }
                    };
                });
            }

            async saveFile(id, file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const transaction = this.db.transaction(['files'], 'readwrite');
                        const store = transaction.objectStore('files');
                        
                        const fileData = {
                            id: id,
                            name: file.name,
                            type: file.type,
                            size: file.size,
                            data: reader.result,
                            timestamp: Date.now()
                        };
                        
                        const request = store.put(fileData);
                        request.onsuccess = () => resolve(fileData);
                        request.onerror = () => reject(request.error);
                    };
                    reader.onerror = () => reject(reader.error);
                    reader.readAsDataURL(file);
                });
            }

            async getFile(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const request = store.get(id);
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteFile(id) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['files'], 'readwrite');
                    const store = transaction.objectStore('files');
                    const request = store.delete(id);
                    
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
            }
        }

        // Initialize file storage
        window.fileStorage = new FileStorage();
    </script>
    
    <style>
        body {
            font-family: 'Barlow', sans-serif;
        }
        
        .file-card {
            transition: all 0.3s ease;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .commented {
            border-left: 4px solid #10b981;
        }
        
        .uncommented {
            border-left: 4px solid #f59e0b;
        }
        
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        
        .upload-area.dragover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        
        .comment-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .nav-link {
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header yang sama dengan index.html -->
    <header class="bg-blue-800 text-white shadow-lg">
        <div class="flex justify-between items-center px-10 py-6">
            <div>
                <h1 class="text-3xl font-bold">MI 22, Bismillah LULUS</h1>
                <p class="mt-2 text-blue-200">Document Review System</p>
            </div>
            <div class="text-right">
                <h3 class="text-blue-200 text-sm font-medium">Last Updated</h3>
                <p class="text-xl font-medium text-white mt-1" id="last-updated">-</p>
            </div>
        </div>
        
        <!-- Navigation Menu -->
        <nav class="bg-blue-900 px-10 py-3 border-t border-blue-700">
            <div class="flex space-x-8">
                <a href="/" class="nav-link text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2">
                    <span>üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="/review.html" class="nav-link active text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2">
                    <span>üìÑ</span>
                    <span>Document Review</span>
                </a>
                <a href="#" class="nav-link text-blue-200 hover:text-white transition-colors duration-200 flex items-center space-x-2" onclick="showInfo()">
                    <span>‚ÑπÔ∏è</span>
                    <span>Info</span>
                </a>
            </div>
        </nav>
    </header>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Upload Section -->
        <div id="uploadSection" class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold text-gray-800">üì§ Unggah Dokumen Baru</h2>
                <div class="flex items-center space-x-2 text-sm text-green-600">
                    <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                    <span>Local Storage Ready - 100% Free!</span>
                </div>
            </div>
            <div id="uploadArea" class="upload-area rounded-lg p-8 text-center cursor-pointer">
                <div class="space-y-4">
                    <div class="text-4xl">‚òÅÔ∏è</div>
                    <div>
                        <p class="text-lg font-medium text-gray-700">Klik atau seret file ke sini</p>
                        <p class="text-sm text-gray-500">Simpan lokal di browser ‚Ä¢ PDF dan Word (.pdf, .doc, .docx) ‚Ä¢ No credit card needed!</p>
                    </div>
                    <input type="file" id="fileInput" accept=".pdf,.doc,.docx" class="hidden">
                </div>
            </div>
            <div id="uploadProgress" class="mt-4 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="uploadStatus" class="text-sm text-gray-600 mt-2">Uploading...</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div class="flex flex-wrap items-center gap-4">
                <h3 class="text-lg font-semibold text-gray-800">Filter:</h3>
                <button onclick="filterFiles('all')" class="filter-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                    Semua File
                </button>
                <button onclick="filterFiles('commented')" class="filter-btn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    üí¨ Ada Komentar
                </button>
                <button onclick="filterFiles('uncommented')" class="filter-btn bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition-colors">
                    ‚è≥ Belum Ada Komentar
                </button>
                <select id="dateFilter" onchange="filterByDate()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="all">Semua Tanggal</option>
                </select>
            </div>
        </div>

        <!-- Documents Section -->
        <div class="space-y-6" id="documentsContainer">
            <!-- Documents will be dynamically added here -->
        </div>
    </div>

    <!-- Comment Modal with File Preview -->
    <div id="commentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-7xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="p-6 border-b border-gray-200 bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <span class="text-2xl">üìÑ</span>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800" id="modalTitle">Review Dokumen</h3>
                            <p class="text-sm text-gray-600" id="modalSubtitle">Preview dan komentar</p>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-3xl font-light">&times;</button>
                </div>
            </div>
            
            <!-- Split Content -->
            <div class="flex h-[calc(90vh-120px)]">
                <!-- Left Panel - File Preview -->
                <div class="w-1/2 border-r border-gray-200 bg-gray-50">
                    <div class="p-4 border-b border-gray-200 bg-white">
                        <h4 class="font-medium text-gray-800 flex items-center">
                            <span class="mr-2">üëÅÔ∏è</span>
                            Preview Dokumen
                        </h4>
                    </div>
                    <div class="p-6 h-full overflow-auto">
                        <div id="filePreviewContainer" class="h-full flex items-center justify-center">
                            <!-- File preview will be loaded here -->
                            <div class="text-center text-gray-500">
                                <div class="text-6xl mb-4">üìÑ</div>
                                <p class="text-lg">Loading preview...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel - Comments -->
                <div class="w-1/2 flex flex-col">
                    <div class="p-4 border-b border-gray-200 bg-white">
                        <h4 class="font-medium text-gray-800 flex items-center justify-between">
                            <span class="flex items-center">
                                <span class="mr-2">üí¨</span>
                                Komentar & Diskusi
                            </span>
                            <span id="commentCount" class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs">0</span>
                        </h4>
                    </div>
                    
                    <!-- Comments List -->
                    <div class="flex-1 p-4 overflow-y-auto bg-gray-50">
                        <div id="commentsContainer" class="space-y-4">
                            <!-- Comments will be displayed here -->
                        </div>
                    </div>
                    
                    <!-- Comment Input -->
                    <div class="p-4 border-t border-gray-200 bg-white">
                        <div class="space-y-3">
                            <textarea id="newComment" placeholder="Tulis komentar atau feedback Anda..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="3"></textarea>
                            <div class="flex items-center justify-between">
                                <input type="text" id="commenterName" placeholder="Nama Anda" class="flex-1 mr-3 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <button onclick="addComment()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors flex items-center space-x-2">
                                    <span>üì§</span>
                                    <span>Kirim</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let documents = [];
        let currentDocumentId = null;
        let unsubscribeDocuments = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            updateCurrentDate();
            setupUploadArea();
            await initializeFileStorage();
            initializeFirestore();
        });



        // Initialize file storage
        async function initializeFileStorage() {
            try {
                await window.fileStorage.init();
                console.log('IndexedDB initialized successfully');
            } catch (error) {
                console.error('Error initializing IndexedDB:', error);
                showNotification('‚ö†Ô∏è Local storage initialization failed', 'error');
            }
        }

        // Initialize Firestore listeners
        function initializeFirestore() {
            if (!window.db) {
                setTimeout(initializeFirestore, 100);
                return;
            }
            
            // Listen to documents collection
            const documentsQuery = window.firestore.query(
                window.firestore.collection(window.db, 'documents'),
                window.firestore.orderBy('uploadDate', 'desc')
            );
            
            unsubscribeDocuments = window.firestore.onSnapshot(documentsQuery, (snapshot) => {
                documents = [];
                snapshot.forEach((doc) => {
                    documents.push({ id: doc.id, ...doc.data() });
                });
                renderDocuments();
                updateDateFilter();
            });
        }

        function updateCurrentDate() {
            const today = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('last-updated').textContent = today.toLocaleDateString('id-ID', options);
        }

        function setupUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFileUpload(e.dataTransfer.files[0]);
            });
            
            fileInput.addEventListener('change', (e) => {
                handleFileUpload(e.target.files[0]);
            });
        }

        async function handleFileUpload(file) {
            if (!file) return;
            
            const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            
            if (!allowedTypes.includes(file.type)) {
                alert('Hanya file PDF dan Word yang diperbolehkan!');
                return;
            }

            // Check file size (max 50MB for local storage)
            const maxSize = 50 * 1024 * 1024; // 50MB
            if (file.size > maxSize) {
                alert('File terlalu besar! Maksimal 50MB untuk local storage.');
                return;
            }

            // Show upload progress
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('uploadStatus');
            
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '10%';
            statusText.textContent = 'Preparing upload...';

            try {
                const today = new Date().toISOString().split('T')[0];
                const fileId = `${today}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                progressBar.style.width = '30%';
                statusText.textContent = 'Saving to local storage...';

                // Save file to IndexedDB
                const savedFile = await window.fileStorage.saveFile(fileId, file);
                
                progressBar.style.width = '70%';
                statusText.textContent = 'Creating document record...';

                const documentData = {
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    uploadDate: today,
                    uploadTime: new Date().toLocaleTimeString('id-ID'),
                    timestamp: window.firestore.serverTimestamp(),
                    commentCount: 0,
                    // Local storage specific data
                    fileId: fileId,
                    isLocalFile: true,
                    previewAvailable: file.type === 'application/pdf'
                };

                // Add document to Firestore
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'documents'),
                    documentData
                );

                progressBar.style.width = '100%';
                statusText.textContent = 'Upload complete!';

                // Reset file input and hide progress
                document.getElementById('fileInput').value = '';
                setTimeout(() => {
                    progressContainer.classList.add('hidden');
                    progressBar.style.width = '0%';
                }, 2000);
                
                // Show success message
                showNotification('‚úÖ Dokumen berhasil disimpan secara lokal!', 'success');
                
            } catch (error) {
                console.error('Error uploading document:', error);
                progressContainer.classList.add('hidden');
                showNotification('‚ùå Gagal menyimpan dokumen!', 'error');
            }
        }



        function renderDocuments() {
            const container = document.getElementById('documentsContainer');
            
            if (documents.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">üìÑ</div>
                        <h3 class="text-xl font-medium text-gray-600 mb-2">Belum ada dokumen</h3>
                        <p class="text-gray-500">Unggah dokumen pertama Anda untuk memulai kolaborasi</p>
                    </div>
                `;
                return;
            }

            // Group documents by date
            const groupedDocs = documents.reduce((groups, doc) => {
                const date = doc.uploadDate;
                if (!groups[date]) groups[date] = [];
                groups[date].push(doc);
                return groups;
            }, {});

            let html = '';
            
            Object.keys(groupedDocs).sort().reverse().forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                html += `
                    <div class="date-group" data-date="${date}">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm mr-3">üìÖ</span>
                            ${formattedDate}
                        </h3>
                        <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                `;
                
                groupedDocs[date].forEach(doc => {
                    const hasComments = doc.commentCount > 0;
                    const fileIcon = getFileIcon(doc.type);
                    const fileSize = formatFileSize(doc.size);
                    
                    html += `
                        <div class="file-card bg-white rounded-lg shadow-md p-6 ${hasComments ? 'commented' : 'uncommented'}" data-status="${hasComments ? 'commented' : 'uncommented'}">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="text-3xl">${fileIcon}</div>
                                    <div>
                                        <h4 class="font-medium text-gray-800 truncate" title="${doc.name}">${doc.name}</h4>
                                        <p class="text-sm text-gray-500">${fileSize} ‚Ä¢ ${doc.uploadTime}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${hasComments ? 
                                        `<span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                            üí¨ ${doc.commentCount}
                                        </span>` : 
                                        `<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium">
                                            ‚è≥ Belum ada komentar
                                        </span>`
                                    }
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <button onclick="openCommentModal('${doc.id}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors text-sm">
                                    ${hasComments ? 'Lihat Komentar' : 'Tambah Komentar'}
                                </button>
                                <button onclick="deleteDocument('${doc.id}')" class="text-red-500 hover:text-red-700 text-sm">
                                    üóëÔ∏è Hapus
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getFileIcon(type) {
            if (type === 'application/pdf') return 'üìÑ';
            if (type.includes('word')) return 'üìù';
            return 'üìÑ';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function openCommentModal(docId) {
            currentDocumentId = docId;
            const doc = documents.find(d => d.id === docId);
            
            document.getElementById('modalTitle').textContent = `Review: ${doc.name}`;
            document.getElementById('modalSubtitle').textContent = `${formatFileSize(doc.size)} ‚Ä¢ Uploaded ${doc.uploadTime}`;
            document.getElementById('commentModal').classList.remove('hidden');
            document.getElementById('commentModal').classList.add('flex');
            
            // Load file preview
            loadFilePreview(doc);
            
            setupCommentsListener();
        }

        async function loadFilePreview(doc) {
            const container = document.getElementById('filePreviewContainer');
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center text-gray-500">
                    <div class="text-6xl mb-4">‚è≥</div>
                    <p class="text-lg">Loading preview...</p>
                    <p class="text-sm">Getting file from local storage</p>
                </div>
            `;
            
            console.log('Loading preview for doc:', doc);
            
            if (!doc.fileId) {
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-lg font-medium">File ID tidak ditemukan</p>
                        <p class="text-sm">Document: ${doc.name}</p>
                        <p class="text-xs text-red-500">Debug: fileId = ${doc.fileId}</p>
                    </div>
                `;
                return;
            }

            try {
                console.log('Getting file from IndexedDB with ID:', doc.fileId);
                
                // Get file from IndexedDB
                const fileData = await window.fileStorage.getFile(doc.fileId);
                console.log('File data retrieved:', fileData ? 'Success' : 'Not found');
                
                if (!fileData) {
                    container.innerHTML = `
                        <div class="text-center text-gray-500">
                            <div class="text-6xl mb-4">‚ùå</div>
                            <p class="text-lg font-medium">File tidak ditemukan di IndexedDB</p>
                            <p class="text-sm">File ID: ${doc.fileId}</p>
                            <p class="text-sm">File mungkin telah dihapus dari local storage</p>
                            <button onclick="checkIndexedDB()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">
                                üîç Debug IndexedDB
                            </button>
                        </div>
                    `;
                    return;
                }
                
                console.log('File type:', doc.type);
                
                if (doc.type === 'application/pdf') {
                    // PDF Preview using data URL with better error handling
                    console.log('Creating PDF preview with data URL length:', fileData.data.length);
                    
                    container.innerHTML = `
                        <div class="w-full h-full flex flex-col">
                            <div class="mb-2 text-sm text-green-600 text-center bg-green-50 p-2 rounded flex items-center justify-between">
                                <span>‚úÖ PDF loaded from IndexedDB (${formatFileSize(fileData.size)})</span>
                                <button onclick="testPDFPreview('${doc.fileId}')" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                    üîß Test Preview
                                </button>
                            </div>
                            <div class="flex-1 relative">
                                <iframe 
                                    id="pdfPreview" 
                                    src="${fileData.data}" 
                                    class="w-full h-full border-2 border-gray-200 rounded-lg" 
                                    type="application/pdf"
                                    onload="console.log('PDF iframe loaded successfully')"
                                    onerror="console.error('PDF iframe failed to load')"
                                >
                                </iframe>
                                
                                <!-- Fallback content if iframe doesn't work -->
                                <div id="pdfFallback" class="absolute inset-0 bg-white rounded-lg border-2 border-gray-200 hidden">
                                    <div class="text-center text-gray-500 p-8 h-full flex flex-col justify-center">
                                        <div class="text-6xl mb-4">üìÑ</div>
                                        <p class="text-lg font-medium mb-2">PDF Preview</p>
                                        <p class="text-sm mb-4 text-yellow-600">Browser tidak dapat menampilkan PDF inline</p>
                                        <div class="space-y-3">
                                            <button onclick="openPDFInNewTab('${doc.fileId}')" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                                üëÅÔ∏è Buka PDF di Tab Baru
                                            </button>
                                            <button onclick="downloadFile('${doc.fileId}', '${doc.name}')" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors">
                                                üì• Download PDF
                                            </button>
                                        </div>
                                        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                            <p class="text-sm text-blue-700">
                                                <strong>üí° Tips:</strong> Gunakan Chrome atau Firefox untuk preview yang lebih baik
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Better PDF loading detection
                    const iframe = document.getElementById('pdfPreview');
                    const fallback = document.getElementById('pdfFallback');
                    
                    let pdfLoadTimeout;
                    let pdfLoaded = false;
                    
                    // Listen for successful load
                    iframe.onload = function() {
                        console.log('PDF iframe loaded successfully');
                        pdfLoaded = true;
                        clearTimeout(pdfLoadTimeout);
                    };
                    
                    // Listen for error
                    iframe.onerror = function() {
                        console.log('PDF iframe failed to load, showing fallback');
                        if (fallback) {
                            iframe.style.display = 'none';
                            fallback.classList.remove('hidden');
                        }
                    };
                    
                    // Fallback timeout - only show if PDF hasn't loaded after reasonable time
                    pdfLoadTimeout = setTimeout(() => {
                        if (!pdfLoaded) {
                            console.log('PDF loading timeout, checking if content is accessible');
                            
                            // More sophisticated check
                            try {
                                // For PDF iframes, contentDocument is often null due to cross-origin restrictions
                                // This is actually normal behavior, so we shouldn't use it as a failure indicator
                                
                                // Instead, check if the iframe src is valid and the element is visible
                                if (iframe.src && iframe.offsetHeight > 0) {
                                    console.log('PDF iframe appears to be working (has src and is visible)');
                                    pdfLoaded = true;
                                } else {
                                    console.log('PDF iframe may not be working, showing fallback');
                                    if (fallback) {
                                        iframe.style.display = 'none';
                                        fallback.classList.remove('hidden');
                                    }
                                }
                            } catch (e) {
                                console.log('PDF preview check completed, assuming it works');
                                pdfLoaded = true;
                            }
                        }
                    }, 5000); // Increased timeout to 5 seconds
                } else if (doc.type.includes('word')) {
                    // Word Document Preview (Limited)
                    container.innerHTML = `
                        <div class="text-center text-gray-500 p-8">
                            <div class="text-6xl mb-4">üìù</div>
                            <p class="text-lg font-medium">${doc.name}</p>
                            <p class="text-sm mb-2">‚úÖ File loaded from IndexedDB (${formatFileSize(fileData.size)})</p>
                            <p class="text-sm mb-6">Word document preview tidak tersedia di browser</p>
                            <div class="space-y-3">
                                <button onclick="downloadFile('${doc.fileId}', '${doc.name}')" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                    üì• Download Document
                                </button>
                                <p class="text-xs text-gray-400">Buka dengan Microsoft Word atau Google Docs</p>
                            </div>
                            <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-700">
                                    <strong>üí° Tips:</strong> Upload ulang sebagai PDF untuk preview yang lebih baik
                                </p>
                            </div>
                            <div class="mt-4 p-4 bg-green-50 rounded-lg">
                                <p class="text-sm text-green-700">
                                    <strong>‚úÖ Local Storage:</strong> File tersimpan di browser Anda - tidak perlu internet!
                                </p>
                            </div>
                        </div>
                    `;
                } else {
                    // Generic file preview
                    container.innerHTML = `
                        <div class="text-center text-gray-500 p-8">
                            <div class="text-6xl mb-4">üìÑ</div>
                            <p class="text-lg font-medium">${doc.name}</p>
                            <p class="text-sm mb-2">‚úÖ File loaded from IndexedDB (${formatFileSize(fileData.size)})</p>
                            <p class="text-sm mb-6">Preview tidak tersedia untuk tipe file ini</p>
                            <button onclick="downloadFile('${doc.fileId}', '${doc.name}')" class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 transition-colors">
                                üì• Download File
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading file preview:', error);
                container.innerHTML = `
                    <div class="text-center text-gray-500">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-lg font-medium">Error loading file</p>
                        <p class="text-sm">Terjadi kesalahan saat memuat file</p>
                        <p class="text-xs text-red-500">Error: ${error.message}</p>
                        <button onclick="checkIndexedDB()" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-lg">
                            üîç Debug IndexedDB
                        </button>
                    </div>
                `;
            }
        }

        let unsubscribeComments = null;

        function setupCommentsListener() {
            // Unsubscribe from previous listener
            if (unsubscribeComments) {
                unsubscribeComments();
            }

            // Listen to comments for current document
            const commentsQuery = window.firestore.query(
                window.firestore.collection(window.db, 'comments'),
                window.firestore.orderBy('timestamp', 'asc')
            );

            unsubscribeComments = window.firestore.onSnapshot(commentsQuery, (snapshot) => {
                const comments = [];
                snapshot.forEach((doc) => {
                    const comment = { id: doc.id, ...doc.data() };
                    if (comment.documentId === currentDocumentId) {
                        comments.push(comment);
                    }
                });
                renderComments(comments);
            });
        }

        function closeModal() {
            document.getElementById('commentModal').classList.add('hidden');
            document.getElementById('commentModal').classList.remove('flex');
            document.getElementById('newComment').value = '';
            document.getElementById('commenterName').value = '';
            
            // Clear file preview
            document.getElementById('filePreviewContainer').innerHTML = `
                <div class="text-center text-gray-500">
                    <div class="text-6xl mb-4">üìÑ</div>
                    <p class="text-lg">Loading preview...</p>
                </div>
            `;
            
            // Unsubscribe from comments listener
            if (unsubscribeComments) {
                unsubscribeComments();
                unsubscribeComments = null;
            }
            
            currentDocumentId = null;
        }

        function renderComments(comments) {
            const container = document.getElementById('commentsContainer');
            const countElement = document.getElementById('commentCount');
            
            // Update comment count
            countElement.textContent = comments.length;
            
            if (comments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üí¨</div>
                        <p class="font-medium">Belum ada komentar</p>
                        <p class="text-sm">Jadilah yang pertama memberikan feedback!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            comments.forEach((comment, index) => {
                const timestamp = comment.timestamp ? 
                    new Date(comment.timestamp.seconds * 1000).toLocaleString('id-ID') : 
                    comment.timestampString || 'Baru saja';
                    
                html += `
                    <div class="comment-bubble bg-white rounded-lg p-4 shadow-sm border border-gray-100">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                                    ${comment.author.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <span class="font-medium text-gray-800">${comment.author}</span>
                                    <div class="text-xs text-gray-500">${timestamp}</div>
                                </div>
                            </div>
                            <span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded-full">#${index + 1}</span>
                        </div>
                        <p class="text-gray-700 leading-relaxed">${comment.text}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Auto scroll to bottom when new comment is added
            container.scrollTop = container.scrollHeight;
        }

        async function addComment() {
            const commentText = document.getElementById('newComment').value.trim();
            const commenterName = document.getElementById('commenterName').value.trim();
            
            if (!commentText || !commenterName) {
                alert('Mohon isi nama dan komentar!');
                return;
            }
            
            try {
                const commentData = {
                    documentId: currentDocumentId,
                    author: commenterName,
                    text: commentText,
                    timestamp: window.firestore.serverTimestamp(),
                    timestampString: new Date().toLocaleString('id-ID')
                };
                
                // Add comment to Firestore
                await window.firestore.addDoc(
                    window.firestore.collection(window.db, 'comments'),
                    commentData
                );

                // Update document comment count
                const docRef = window.firestore.doc(window.db, 'documents', currentDocumentId);
                const doc = documents.find(d => d.id === currentDocumentId);
                await window.firestore.updateDoc(docRef, {
                    commentCount: (doc.commentCount || 0) + 1
                });
                
                document.getElementById('newComment').value = '';
                document.getElementById('commenterName').value = '';
                
                showNotification('‚úÖ Komentar berhasil ditambahkan!', 'success');
                
            } catch (error) {
                console.error('Error adding comment:', error);
                showNotification('‚ùå Gagal menambahkan komentar!', 'error');
            }
        }

        // Download file function
        async function downloadFile(fileId, fileName) {
            try {
                const fileData = await window.fileStorage.getFile(fileId);
                if (!fileData) {
                    showNotification('‚ùå File tidak ditemukan!', 'error');
                    return;
                }

                // Create download link
                const link = document.createElement('a');
                link.href = fileData.data;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('‚úÖ File berhasil didownload!', 'success');
            } catch (error) {
                console.error('Error downloading file:', error);
                showNotification('‚ùå Gagal mendownload file!', 'error');
            }
        }

        async function deleteDocument(docId) {
            if (confirm('Apakah Anda yakin ingin menghapus dokumen ini?')) {
                try {
                    const doc = documents.find(d => d.id === docId);
                    
                    // Delete file from IndexedDB
                    if (doc && doc.fileId) {
                        await window.fileStorage.deleteFile(doc.fileId);
                    }

                    // Delete document from Firestore
                    await window.firestore.deleteDoc(
                        window.firestore.doc(window.db, 'documents', docId)
                    );

                    // Delete associated comments
                    const commentsQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'comments')
                    );
                    
                    const commentsSnapshot = await window.firestore.onSnapshot(commentsQuery, async (snapshot) => {
                        const batch = [];
                        snapshot.forEach((doc) => {
                            const comment = doc.data();
                            if (comment.documentId === docId) {
                                batch.push(window.firestore.deleteDoc(doc.ref));
                            }
                        });
                        await Promise.all(batch);
                    });

                    showNotification('‚úÖ Dokumen berhasil dihapus dari local storage!', 'success');
                    
                } catch (error) {
                    console.error('Error deleting document:', error);
                    showNotification('‚ùå Gagal menghapus dokumen!', 'error');
                }
            }
        }

        function filterFiles(status) {
            const cards = document.querySelectorAll('.file-card');
            
            cards.forEach(card => {
                if (status === 'all' || card.dataset.status === status) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-blue-300');
            });
            event.target.classList.add('ring-2', 'ring-blue-300');
        }

        function updateDateFilter() {
            const dateFilter = document.getElementById('dateFilter');
            const dates = [...new Set(documents.map(doc => doc.uploadDate))].sort().reverse();
            
            // Clear existing options except "Semua Tanggal"
            dateFilter.innerHTML = '<option value="all">Semua Tanggal</option>';
            
            dates.forEach(date => {
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('id-ID');
                const option = document.createElement('option');
                option.value = date;
                option.textContent = formattedDate;
                dateFilter.appendChild(option);
            });
        }

        function filterByDate() {
            const selectedDate = document.getElementById('dateFilter').value;
            const dateGroups = document.querySelectorAll('.date-group');
            
            dateGroups.forEach(group => {
                if (selectedDate === 'all' || group.dataset.date === selectedDate) {
                    group.style.display = 'block';
                } else {
                    group.style.display = 'none';
                }
            });
        }

        // Close modal when clicking outside
        document.getElementById('commentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white font-medium transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-blue-500');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // Animate out and remove
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Handle Enter key in comment textarea
        document.getElementById('newComment').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) {
                addComment();
            }
        });

        // Debug functions
        async function checkIndexedDB() {
            try {
                console.log('=== IndexedDB Debug Info ===');
                
                // Check if IndexedDB is available
                if (!window.indexedDB) {
                    alert('‚ùå IndexedDB tidak tersedia di browser ini!');
                    return;
                }
                
                // Check if our database exists
                const request = indexedDB.open('MI22DocumentStorage', 1);
                
                request.onsuccess = async (event) => {
                    const db = event.target.result;
                    console.log('Database opened successfully');
                    
                    // Get all files
                    const transaction = db.transaction(['files'], 'readonly');
                    const store = transaction.objectStore('files');
                    const getAllRequest = store.getAll();
                    
                    getAllRequest.onsuccess = () => {
                        const allFiles = getAllRequest.result;
                        console.log('All files in IndexedDB:', allFiles);
                        
                        let debugInfo = `üìä IndexedDB Debug Info:\n\n`;
                        debugInfo += `Database: MI22DocumentStorage\n`;
                        debugInfo += `Total files: ${allFiles.length}\n\n`;
                        
                        if (allFiles.length > 0) {
                            debugInfo += `Files:\n`;
                            allFiles.forEach((file, index) => {
                                debugInfo += `${index + 1}. ${file.name} (ID: ${file.id})\n`;
                                debugInfo += `   Type: ${file.type}\n`;
                                debugInfo += `   Size: ${formatFileSize(file.size)}\n\n`;
                            });
                        } else {
                            debugInfo += `‚ùå Tidak ada file di IndexedDB\n`;
                            debugInfo += `Coba upload file terlebih dahulu\n`;
                        }
                        
                        alert(debugInfo);
                    };
                };
                
                request.onerror = () => {
                    console.error('Error opening database:', request.error);
                    alert('‚ùå Error membuka IndexedDB database!');
                };
                
            } catch (error) {
                console.error('Debug error:', error);
                alert(`‚ùå Debug error: ${error.message}`);
            }
        }

        // Test PDF preview function
        async function testPDFPreview(fileId) {
            try {
                const fileData = await window.fileStorage.getFile(fileId);
                if (!fileData) {
                    alert('‚ùå File tidak ditemukan!');
                    return;
                }
                
                const iframe = document.getElementById('pdfPreview');
                const fallback = document.getElementById('pdfFallback');
                
                let testInfo = `üîß PDF Preview Test Results:\n\n`;
                testInfo += `File ID: ${fileId}\n`;
                testInfo += `File Name: ${fileData.name}\n`;
                testInfo += `File Size: ${formatFileSize(fileData.size)}\n`;
                testInfo += `Data URL Length: ${fileData.data.length}\n`;
                testInfo += `Data URL Start: ${fileData.data.substring(0, 50)}...\n\n`;
                
                if (iframe) {
                    testInfo += `Iframe Status:\n`;
                    testInfo += `- Exists: ‚úÖ\n`;
                    testInfo += `- Has src: ${iframe.src ? '‚úÖ' : '‚ùå'}\n`;
                    testInfo += `- Visible: ${iframe.offsetHeight > 0 ? '‚úÖ' : '‚ùå'}\n`;
                    testInfo += `- Height: ${iframe.offsetHeight}px\n`;
                    testInfo += `- Width: ${iframe.offsetWidth}px\n\n`;
                }
                
                if (fallback) {
                    testInfo += `Fallback Status:\n`;
                    testInfo += `- Hidden: ${fallback.classList.contains('hidden') ? '‚úÖ' : '‚ùå'}\n`;
                }
                
                testInfo += `\nBrowser Info:\n`;
                testInfo += `- User Agent: ${navigator.userAgent.substring(0, 50)}...\n`;
                testInfo += `- PDF Plugin: ${navigator.mimeTypes['application/pdf'] ? '‚úÖ' : '‚ùå'}\n`;
                
                // Force show iframe and hide fallback for testing
                if (iframe && fallback) {
                    iframe.style.display = 'block';
                    fallback.classList.add('hidden');
                    testInfo += `\nüîß Forced iframe to show for testing`;
                }
                
                alert(testInfo);
                
            } catch (error) {
                alert(`‚ùå Test error: ${error.message}`);
            }
        }

        // Open PDF in new tab
        async function openPDFInNewTab(fileId) {
            try {
                const fileData = await window.fileStorage.getFile(fileId);
                if (fileData && fileData.data) {
                    const newWindow = window.open();
                    newWindow.document.write(`
                        <html>
                            <head><title>PDF Preview</title></head>
                            <body style="margin:0;">
                                <iframe src="${fileData.data}" style="width:100%;height:100vh;border:none;"></iframe>
                            </body>
                        </html>
                    `);
                } else {
                    showNotification('‚ùå File tidak ditemukan!', 'error');
                }
            } catch (error) {
                console.error('Error opening PDF:', error);
                showNotification('‚ùå Gagal membuka PDF!', 'error');
            }
        }

        // Info function
        function showInfo() {
            alert('üìÑ Document Review System\n\n‚úÖ Upload dokumen PDF/Word\n‚úÖ Komentar real-time\n‚úÖ Kolaborasi multi-user\n‚úÖ Filter dan pencarian\n‚úÖ Local Storage (IndexedDB)\n\nDeveloped for MI 22 - Astra Tech');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'966088cea1e37549',t:'MTc1MzY2NTQyMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
